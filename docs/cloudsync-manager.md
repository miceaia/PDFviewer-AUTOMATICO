# CloudSync_Manager Codex Reference

## Description
`CloudSync_Manager` centralises the two-way synchronisation between WordPress custom post types (`curso` and `leccion`) and supported cloud providers. It registers the required post types, hooks into save/delete events, and coordinates cron jobs that poll remote APIs.

When a lesson (`leccion`) is stored it resolves the parent course folder first, guaranteeing that sub-folders are created beneath the correct course container across every connector.

## Usage
```php
$manager = new CloudSync_Manager();
$manager->init();
```

This bootstrapper should run during the `plugins_loaded` lifecycle (already handled by the plugin bootstrap). You can manually instantiate the manager when writing integration tests or extending the plugin.

## Actions
- `cloudsync_after_create_course( int $post_id, string $folder_id )`
  Fired when a new remote folder is linked to a **course**. Use this to enqueue background tasks or to register additional metadata for that course record.

## Filters
- `cloudsync_course_folder_name( string $name, int $post_id )`
  Filter the folder name before it is sent to the remote APIs. Useful for appending unique slugs or enforcing naming conventions.

## Credential storage & security
CloudSync LMS persists credentials per service using dedicated option keys:

- Google Drive: `cloudsync_drive_client_id`, `cloudsync_drive_client_secret`, `cloudsync_drive_refresh_token`.
- Dropbox: `cloudsync_dropbox_client_id`, `cloudsync_dropbox_client_secret`, `cloudsync_dropbox_refresh_token`.
- SharePoint/OneDrive: `cloudsync_sharepoint_tenant_id`, `cloudsync_sharepoint_client_id`, `cloudsync_sharepoint_secret`, `cloudsync_sharepoint_refresh_token`.

Secrets and tokens are encrypted with AES-256-CBC using the WordPress salt stack. If OpenSSL is unavailable the plugin logs a warning and stores the values in plain text so administrators can still complete the setup.

Utility functions:

- `cloudsync_get_service_credentials( string $service )` returns a decrypted associative array for the requested provider (`google`, `dropbox`, `sharepoint`).
- `cloudsync_store_service_credentials( string $service, array $values, bool $preserve_empty = true )` updates option values and keeps previously stored secrets when empty fields are submitted from the dashboard.
- `cloudsync_add_log( string $message, array $context = [] )` persists diagnostic entries visible under **CloudSync LMS â†’ Logs**.

## OAuth setup
Each connector shares a consistent OAuth flow. The admin dashboard exposes per-service cards that submit through `admin-post.php` and open the provider consent screen in a popup window.

### Google Drive
1. Create an OAuth client (type **Web application**) in Google Cloud Console.
2. Add the redirect URI generated by `cloudsync_get_oauth_redirect_uri( 'google' )`, e.g. `https://example.com/wp-admin/admin-post.php?action=cloudsync_oauth_callback&service=google`.
3. Paste the **Client ID** and **Client Secret** in the dashboard and click **Guardar credenciales**.
4. Click **Dar acceso** to launch the popup. After authorising, the window closes automatically and the status badge switches to ðŸŸ¢.

### Dropbox
1. Register a Scoped Access application in Dropbox App Console with the scopes `files.metadata.read` and `files.metadata.write`.
2. Configure the redirect URI suggested by the dashboard (`service=dropbox`).
3. Save the **App Key / Client ID** and **App Secret / Client Secret** and authorise via **Dar acceso**.

### SharePoint / OneDrive
1. Create an Azure AD application, collect the **Tenant ID**, **Client ID** and **Client Secret**, and grant the delegated permission `Files.ReadWrite.All`.
2. Add the redirect URI provided by `cloudsync_get_oauth_redirect_uri( 'sharepoint' )`.
3. Enter the tenant, client and secret in the dashboard and authorise to store the refresh token.

The plugin stores `access_token` and `token_expires` timestamps for every connector so future API calls can reuse the cached token.

## Extending Connectors
Each connector must implement [`CloudSync_Connector_Interface`](../includes/interface-cloudsync-connector.php) which declares the following methods:

```php
public function create_folder( $name, $parent_id = null );
public function list_changes( $since_token );
public function rename_folder( $id, $new_name );
public function delete_folder( $id );
```

To add a new provider create a class that matches this interface and register it from a `plugins_loaded` callback:

```php
add_action( 'plugins_loaded', function() {
    require_once plugin_dir_path( __FILE__ ) . 'includes/class-connector-myservice.php';
    $manager = SecurePDFViewer::get_instance();
    // Use hooks exposed by CloudSync_Manager to inject the new connector.
} );
```

## Remote â†’ WordPress sync & automation
Remote changes are processed by the `cloudsync_check_remote_changes` cron event according to the interval configured under **ConfiguraciÃ³n â†’ Intervalo de sincronizaciÃ³n**.

Access tokens are refreshed hourly through the `cloudsync_refresh_tokens` cron hook. The helper method `refresh_service_tokens()` checks whether a refresh token exists before attempting to renew the access token and logs a warning if the provider does not return a valid token.

Two WP-CLI commands are registered for automation workflows:

```bash
wp cloudsync:sync
wp cloudsync:reset-tokens [--service=google|dropbox|sharepoint]
```

The first command triggers an immediate synchronisation pass, while the second clears stored refresh/access tokens (useful when rotating secrets from CI/CD pipelines).

## Error handling & debugging
The manager stores up to 200 log entries. Use `cloudsync_get_logs()` programmatically or download them from **CloudSync LMS â†’ Monitor / Logs**.

Example `debug.log` excerpt after saving Dropbox credentials and performing an automatic token refresh:

```text
[CloudSync] save_credentials POST received.
[CloudSync] Credentials stored for dropbox (client:updated, secret:updated, token:empty)
[CloudSync] Credentials saved for dropbox.
[08-Jan-2025 11:04:12 UTC] [CloudSync] No fue posible actualizar el token de dropbox.
```

If you see the warning above, confirm that the refresh token exists in the dashboard and re-authorise the service if necessary.

## SharePoint roadmap
1. Configure Azure AD credentials in **ConfiguraciÃ³n â†’ Credenciales** and complete the OAuth flow as described above.
2. Implement the REST calls inside `Connector_SharePoint` using `wp_remote_get()` / `wp_remote_post()` to interact with Microsoft Graph.
3. Store resulting folder IDs in the `_sp_folder_id` meta.
4. Register Microsoft Graph webhooks to receive delta notifications and call `$manager->pull_remote_changes()` when they fire.
